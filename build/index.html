<!DOCTYPE html><html><head><title>Dreaming of Fire</title><link rel="shortcut icon" id="favicon" /><style>body{padding:0px;margin:0px;background:rgb(128,128,128);}#GameHere{background-color: rgb(170,170,170);margin-left:auto;margin-right:auto;-webkit-user-select:none;
-moz-user-select:none;-ms-user-select:none;}</style></head><body><div id="GameHere"></div>
<script>function createCanvas(a,b,c,d){var e=document.createElement("canvas");e.style.position="absolute",e.id=c,e.width=a,e.height=b,e.style.top="0px","undefined"!=typeof d?document.getElementById(d).appendChild(e):document.body.appendChild(e)}function deleteCanvas(a){null!==a&&null!==document.getElementById(a)&&document.getElementById(a).parentNode.removeChild(document.getElementById(a))}function randomRange(a,b){return Math.random()*(b-a)+a}function rgbStringToInt(a){var b={r:0,g:0,b:0};return b.r=parseInt(a.substring(a.indexOf("(")+1,a.indexOf(","))),b.g=parseInt(a.substring(a.indexOf(",")+1,a.lastIndexOf(","))),b.b=parseInt(a.substring(a.lastIndexOf(",")+1,a.lastIndexOf(")"))),b}function rgbIntToString(a){return"rgb("+a.r+","+a.g+","+a.b+")"}function offsetColour(a,b,c,d){var e,f,g,h=rgbStringToInt(a);return d&&"undefined"!=typeof d?(e=Math.round(randomRange(b,c)),f=Math.round(randomRange(b,c)),g=Math.round(randomRange(b,c))):e=f=g=Math.round(randomRange(b,c)),h.r+=e,h.g+=f,h.b+=g,h.r=keepWithinRange(h.r,0,255),h.g=keepWithinRange(h.g,0,255),h.b=keepWithinRange(h.b,0,255),rgbIntToString(h)}function keepWithinRange(a,b,c){return b>a?a=b:a>c&&(a=c),a}function GameLoop(){requestAnimation(GameLoop),MainGame.input(),MainGame.update(),MainGame.render()}var requestAnimation=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame,Point=function(a,b){this.x="undefined"==typeof a?null:a,this.y="undefined"==typeof b?null:b};Point.prototype={equals:function(a){this.x=a.x,this.y=a.y},set:function(a,b){this.x=a,this.y=b}};var StartMenu={canvasElement:null,create:function(){this.canvasElement=document.getElementById(MainGame.currentState)},onClick:function(){Input.mousePosition.x>115&&Input.mousePosition.x<375&&Input.mousePosition.y>285&&Input.mousePosition.y<385&&MainGame.startState("city")},render:function(){var a=this.canvasElement.getContext("2d"),b=a.createRadialGradient(250,560,25,250,560,600);b.addColorStop(0,"rgb(255,203,102)"),b.addColorStop(.4,"rgb(231,60,6)"),b.addColorStop(1,"rgb(18,13,3)"),a.fillStyle=b,a.fillRect(0,0,500,560),a.fillStyle="rgb(18,13,3)",a.fillRect(115,287,260,100),a.fillStyle=Input.mousePosition.x>115&&Input.mousePosition.x<375&&Input.mousePosition.y>285&&Input.mousePosition.y<385?"rgb(97,17,8)":"rgb(58,23,8)",a.fillRect(115,282,260,100),a.font="bold 51pt Arial",a.textAlign="center",a.fillStyle="rgb(25,25,25)",a.fillText("Ignite",250,347),a.font="bold 50pt Arial",a.fillStyle="rgb(255,158,62)",a.fillText("Ignite",250,350),a.fillStyle="rgb(18,13,3)",a.font="normal 15pt Arial",a.fillText("Jeremy de Reuck - Programming and Art",245,505),a.fillText("Janke van Jaarsveld - Game Design",245,535),a.fillStyle="rgb(255,158,62)",a.shadowColor="rgb(18,13,3)",a.shadowOffsetX=0,a.shadowOffsetY=-30,a.shadowBlur=60,a.font="bold 60pt Arial",a.fillText("Dreaming of",245,85),a.font="bold 90pt Arial",a.fillText("FIRE",245,210),a.fillStyle="rgb(255,158,62)",a.shadowColor="rgb(18,13,3)",a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=20,a.font="bold 60pt Arial",a.fillText("Dreaming of",245,85),a.font="bold 90pt Arial",a.fillText("FIRE",245,210)}},Hexagon=function(a,b,c){this.SIDES=6,this.radius=a,this.center=new Point(b,c),this.mouseOver=!1,this.selected=!1,this.visible=!0,this.width=2*this.radius,this.height=Math.sqrt(3)/2*this.width,this.strokeColour="rgb(0,0,0)",this.fillColour="rgb(128,128,128)",this.strokeWidth=.5};Hexagon.prototype={draw:function(a){if(this.visible){var b=document.getElementById(a).getContext("2d");b.beginPath();var c=2*Math.PI/this.SIDES*0;b.moveTo(this.center.x+this.radius*Math.cos(c),this.center.y+this.radius*Math.sin(c));for(var d=1;d<=this.SIDES;d++)c=2*Math.PI/this.SIDES*d,b.lineTo(this.center.x+this.radius*Math.cos(c),this.center.y+this.radius*Math.sin(c));b.strokeStyle=this.strokeColour,b.fillStyle=this.fillColour,b.lineWidth=this.strokeWidth,b.closePath(),b.fill(),b.stroke()}},setStroke:function(a,b){this.strokeColour=a,this.strokeWidth=b},setFill:function(a){this.fillColour=a},setRadius:function(a){this.radius=a},setCenter:function(a,b){this.center.x=a,this.center.y=b},setCenterFromPoint:function(a){this.setCenter(a.x,a.y)},getFill:function(){return this.fillColour},calculateDimentions:function(){this.width=2*this.radius,this.height=Math.sqrt(3)/2*this.width},getHeight:function(){return this.height},getWidth:function(){return this.width}};var tileTypes={none:0,river:11},Tile=function(a,b,c,d){this.visualHexagon=new Hexagon(a,b,c),this.mapIndex=new Point(0,0),this.districtIndex=null,this.population=0,this.destruction=0,this.mouseOver=!1,this.visible=!0,this.animating=!1,this.burning=!1,this.fireSpread=!1,this.charred=!1,this.startedBurning=null,this.type=tileTypes.none,"undefined"!=typeof tileTypes[d]&&(this.type=tileTypes[d]),this.district=null,this.maxFuel=0,this.fuel=0,this.fireStrength=0,this.spreadResistance=0,this.burnTime=0,this.baseColour=GameMap.emptyColour,this.setStroke("rgb(0,0,0)",.5),this.setFill("rgb(128,128,128)"),this.fireAnimTimer=null,this.animTime=250,this.setupTile()};Tile.prototype={setupTile:function(){this.type===tileTypes.none?(this.maxFuel=60,this.fuel=this.maxFuel,this.spreadResistance=.5,this.burnTime=1e3):this.type===tileTypes.river&&(this.maxFuel=0,this.fuel=this.maxFuel,this.spreadResistance=1,this.burnTime=0)},setMapIndex:function(a,b){this.mapIndex.x=a,this.mapIndex.y=b},burn:function(){this.burning&&!this.charred&&this.animateFire(),this.burnTime<GameMap.timePerHour&&MainGame.timeNow()-this.startedBurning>=this.burnTime?this.fireStrength+=Fire.strenghtIncrease:MainGame.timeNow()-this.startedBurning>=this.burnTime&&(this.fireStrength+=Fire.strenghtIncrease),this.fireStrength>Fire.maxiumStrength&&(this.fireStrength=Fire.maxiumStrength),MainGame.timeNow()-this.startedBurning>=this.burnTime&&this.calculateEffectiveFuel()>0&&(this.fuel--,this.updateDestruction(),this.startedBurning=MainGame.timeNow())},animateFire:function(){if(null===this.fireAnimTimer||MainGame.timeNow()-this.fireAnimTimer>this.animTime){this.fireAnimTimer=MainGame.timeNow();var a=randomRange(0,1),b=Fire.fireColour;.3333>a?b=Fire.fireHighlight:.6666>a&&(b=Fire.fireDarkColour),Motion.fadeTileColourTo(this,b,this.animTime),this.animTime=Math.round(randomRange(300,450))}},calculateEffectiveFuel:function(){return this.fuel-this.maxFuel*GameMap.districts[this.districtIndex].getFuelModifier()},draw:function(a){this.visible&&this.visualHexagon.draw(a)},killPeople:function(){GameMap.districts[this.districtIndex].population-=this.population,this.population=0,GameMap.countPopulation(),UI.displayAreaInfo()},updateDestruction:function(){this.destruction++,GameMap.districts[this.districtIndex].destruction++,GameMap.destruction++,UI.displayAreaInfo()},calculateDimentions:function(){this.visualHexagon.calculateDimentions()},setDistrictIndex:function(a){this.districtIndex=a},setStroke:function(a,b){this.visualHexagon.setStroke(a,b)},setFill:function(a){this.visualHexagon.setFill(a)},setRadius:function(a){this.visualHexagon.setRadius(a)},setCenter:function(a,b){this.visualHexagon.setCenter(a,b)},setCenterFromPoint:function(a){this.visualHexagon.setCenterFromPoint(a)},setType:function(a){"undefined"!=typeof tileTypes[a]&&(this.type=tileTypes[a],this.setupTile())},setBaseColour:function(a){this.baseColour=a},getFill:function(){return this.visualHexagon.getFill()},getTotalFireResistance:function(){return this.fireResistance+Fire.naturalResistance+GameMap.districts[this.districtIndex].fireResistance},getHeight:function(){return this.visualHexagon.getHeight()},getWidth:function(){return this.visualHexagon.getWidth()}};var districtTypes={names:["none","industrial","commercial","residential"],none:0,industrial:1,commercial:2,residential:3,name:function(a){return a>=0&&3>=a?this.names[a]:"INVALID"}},District=function(a,b){this.name="",this.mainType="undefined"==typeof a||"undefined"==typeof districtTypes[a]?districtTypes.none:districtTypes[a],this.tiles=[],this.numberOfTiles=0,this.baseColour=b,this.fireProc=.08,this.fireStaringByZealotMod=.006,this.tileResistance=.92,this.clericResistanceModifier=.01,this.flammable=!1,this.destroyed=!1,this.clerics=[],this.zealots=[],this.numberOfFollowers={clerics:0,zealots:0},this.followerSpawnChance=.08,this.followerSpawnFireMod=.002,this.clericChance=.5,this.spawnTestTimer=null,this.spawnTestTime=1e3,this.fireTestTimer=null,this.fireTestTime=1e3,this.fireCounter=0,this.startingPopulation=0,this.population=0,this.deaths=0,this.destruction=0,this.firesStarted=0,this.mouseOver=!1,this.displayUpdated=!1,this.determineName()};District.prototype={determineName:function(){var a=districtTypes.name(this.mainType);this.name=a.charAt(0).toUpperCase()+a.slice(1)+" District"},addTile:function(a,b){this.tiles[this.numberOfTiles]=a,this.tiles[this.numberOfTiles].setFill(this.baseColour),this.tiles[this.numberOfTiles].setBaseColour(this.baseColour),this.tiles[this.numberOfTiles].districtIndex=b,this.numberOfTiles++},initialPopulation:function(){var a=0,b=0;this.population=0,this.mainType===districtTypes.industrial?(a=0,b=2):this.mainType===districtTypes.commercial?(a=1,b=4):this.mainType===districtTypes.residential&&(a=2,b=6);for(var c in this.tiles)this.tiles[c].population=Math.round(randomRange(a,b)),this.population+=this.tiles[c].population;this.startingPopulation=this.population},addFollower:function(a){this.flammable=!0,newFollower=new Follower(a),a=newFollower.fireClass,this[a+"s"][this[a+"s"].length]=new Follower(a),this.calculateStats()},killFollower:function(a){if("undefined"!=typeof this[a+"s"]){var b=!1;for(var c in this[a+"s"])if(this[a+"s"][c].alive){this[a+"s"][c].kill(),b=!0,this.calculateStats();break}}},newFireStarted:function(){this.firesStarted++,this.calculateStats()},countFollowers:function(){this.numberOfFollowers={clerics:0,zealots:0};for(var a in this.clerics)this.clerics[a].alive&&this.numberOfFollowers.clerics++;for(var b in this.zealots)this.zealots[b].alive&&this.numberOfFollowers.zealots++},tryToSpawnFollowers:function(){if(!this.destroyed&&(MainGame.timeNow()-this.spawnTestTimer>=this.spawnTestTime||null===this.spawnTestTimer)&&(this.spawnTestTimer=MainGame.timeNow(),this.firesStarted>0)){var a=randomRange(0,1);if(this.followerSpawnChance+this.followerSpawnFireMod*this.firesStarted+FireTech.followerSpawnMod>a){var b=randomRange(0,1);this.addFollower(this.clericChance+FireTech.clericSpawnMod>b?"cleric":"zealot")}GameMap.countFollowers()}},tryToStartFire:function(){if(MainGame.timeNow()-this.fireTestTimer>=this.fireTestTime||null===this.fireTestTimer){this.fireTestTimer=MainGame.timeNow();var a=randomRange(0,1);this.flammable&&this.fireCounter++,this.fireCounter>=10,(this.flammable&&this.fireProc+this.numberOfFollowers.zealots*this.fireStaringByZealotMod+FireTech.fireProcMod>a||this.fireCounter>=10)&&(this.startFire(),this.checkDestroyed(),this.fireCounter=0)}},startFire:function(){var a=!1,b=!1,c=0;for(var d in this.tiles)if(!this.tiles[d].burning&&!this.tiles[d].charred&&this.tiles[d].fuel>0){a=!0;break}if(a)do c=Math.round(randomRange(0,this.numberOfTiles-1)),!this.tiles[c].burning&&!this.tiles[c].charred&&this.tiles[c].fuel>0&&(Fire.setOnFire(this.tiles[c]),b=!0);while(!b)},followerMigrate:function(a,b){var c="cleric";0===a.indexOf("z")&&(c="zealot"),this.numberOfFollowers[c+"s"]>0&&(b.addFollower(c),this.killFollower(c))},calculateStats:function(){GameMap.countFollowers()},getFuelModifier:function(){return keepWithinRange(this.tileResistance-this.numberOfFollowers.clerics*this.clericResistanceModifier-FireTech.fuelModifierMod,0,1)},onMouseOver:function(){if(!this.mouseOver){for(var a in this.tiles)this.tiles[a].burning||Motion.fadeTileColourTo(this.tiles[a],GameMap.hoverColour,200),this.tiles[a].mouseOver=!0;this.displayUpdated=!1}this.mouseOver=!0,this.displayUpdated||(UI.displayAreaInfo(),this.displayUpdated=!0)},onMouseOff:function(){if(this.mouseOver){for(var a in this.tiles)this.tiles[a].burning||(this.tiles[a].charred?Motion.fadeTileColourTo(this.tiles[a],Fire.charredColour,250):Motion.fadeTileColourTo(this.tiles[a],this.tiles[a].baseColour,250)),this.tiles[a].mouseOver=!1;this.displayUpdated=!1}this.mouseOver=!1,this.displayUpdated||(UI.displayAreaInfo(),this.displayUpdated=!0)},checkDestroyed:function(){if(!this.destroyed){var a=!1;for(var b in this.tiles)this.tiles[b].charred||this.tiles[b].burning||(a=!0);a||(this.destroyed=!0,GameMap.destroyedDistricts++,1===GameMap.destroyedDistricts&&UI.displayEvent("You have completely destroyed"," the "+this.name+"!"))}}};var HexagonalGridSystem={radius:16,calculateHexagonWidth:function(a){return 2*a},calculateHexagonHeight:function(){return Math.sqrt(3)/2*this.calculateHexagonWidth()},gridCoordToPixelCoord:function(a,b){return this.externalGridCoordToPixelCoord(a,b,this.radius)},pixelCoordToGridCoord:function(a,b){return this.externalPixelCoordToGridCoord(a,b,this.radius)},externalGridCoordToPixelCoord:function(a,b,c){"undefined"==typeof b&&(b=new Point(0,0));var d=0,e=0;return d=3*c/2*a.x,e=c*Math.sqrt(3)*(a.y+a.x/2),new Point(d+b.x,e+b.y)},externalPixelCoordToGridCoord:function(a,b,c){"undefined"==typeof b&&(b=new Point(0,0)),pPoint=new Point(a.x,a.y),pPoint.x-=b.x,pPoint.y-=b.y;var d=new Point(0,0);d.x=2/3*pPoint.x/c,d.y=(1/3*Math.sqrt(3)*pPoint.y-1/3*pPoint.x)/c;var e=this.hexRound(this.convertAxialToCube(d));return this.convertCubeToAxial(e)},hexRound:function(a){var b={x:Math.round(a.x),y:Math.round(a.y),z:Math.round(a.z)},c={x:Math.abs(b.x-a.x),y:Math.abs(b.y-a.y),z:Math.abs(b.z-a.z)};return c.x>c.y&&c.x>c.z?b.x=-b.y-b.z:c.y>c.z?b.y=-b.x-b.z:b.z=-b.x-b.y,b},convertAxialToCube:function(a){return{x:a.x,y:a.y,z:-a.x-a.y}},convertCubeToAxial:function(a){return new Point(a.x,a.y)},setRadius:function(a){this.radius=a}},GenerateMap={edgeRoughness:.75,edgeDepth:2,minRiverWidth:1,maxRiverWidth:3,riverSpread:4,riverRoughness:.25,riverBends:.8,minDistricts:6,maxDistricts:8,districtsTop:0,districtsBottom:0,districtLineStarts:[],borderOffset:2,borderRoughness:.8,borderVariance:3,borderGenColour:"rgb(165,110,55)",directionModifier:["up","down"],leftMiddleTile:new Point(-19,9),leftTopTile:new Point(-19,-1),rightTopTile:new Point(19,-20),rightBottomTile:new Point(19,1),leftBottomTile:new Point(-19,20),create:function(){this.defineOuterEdge(),this.createRiver(),this.defineDistricts(),GameMap.indexOfFirstBottomDistrict=this.districtsTop,this.validateMap()},defineOuterEdge:function(){var a=new Point(this.leftTopTile.x,this.leftTopTile.y),b=GameMap.findTileAtGridIndex(a),c=0,d=0,e=0;do e=this.randomEdge("down",a,e,d),c=randomRange(0,1),this.edgeRoughness>c&&(d=Math.round(randomRange(0,this.edgeDepth))),a=Navigation.moveRight(a,"up"),b=GameMap.findTileAtGridIndex(a),null===b&&(a=Navigation.moveLeft(a,"down"),a=Navigation.moveRight(a,"down"),b=GameMap.findTileAtGridIndex(a),null===b&&(a=Navigation.moveLeft(a,"up"),b=GameMap.findTileAtGridIndex(a)));while(a.x!==this.rightTopTile.x||a.y!==this.rightTopTile.y);e=this.randomEdge("down",a,e,d);do e=this.randomEdge("left",a,e,d),c=randomRange(0,1),this.edgeRoughness>c&&(d=Math.round(randomRange(0,this.edgeDepth))),a=Navigation.moveDown(a),b=GameMap.findTileAtGridIndex(a),null===b&&(a=Navigation.moveUp(a));while(null!==b);do e=this.randomEdge("up",a,e,d),c=randomRange(0,1),this.edgeRoughness>c&&(d=Math.round(randomRange(0,this.edgeDepth))),a=Navigation.moveLeft(a,"down"),b=GameMap.findTileAtGridIndex(a),null===b&&(a=Navigation.moveRight(a,"up"),a=Navigation.moveLeft(a,"up"),b=GameMap.findTileAtGridIndex(a),null===b&&(a=Navigation.moveRight(a,"down"),b=GameMap.findTileAtGridIndex(a)));while(a.x!==this.leftBottomTile.x||a.y!==this.leftBottomTile.y);e=this.randomEdge("up",a,e,d);do e=this.randomEdge("right",a,e,d),c=randomRange(0,1),this.edgeRoughness>c&&(d=Math.round(randomRange(0,this.edgeDepth))),a=Navigation.moveUp(a),b=GameMap.findTileAtGridIndex(a),null===b&&(a=Navigation.moveDown(a));while(a.x!==this.leftTopTile.x||a.y!==this.leftTopTile.y);e=this.randomEdge("right",a,e,d)},randomEdge:function(a,b,c,d){a="move"+a.charAt(0).toUpperCase()+a.slice(1);var e=c,f=GameMap.findTileAtGridIndex(b);e="moveUp"===a||"moveDown"===a?d>c&&b.x%2!==1?c+1:c>d&&b.x%2!==0?c-1:c:d>c?c+1:c>d?c-1:c;for(var g=0;e>g;g++)f.visible=!1,b=Navigation[a](b,this.directionModifier[g%2]),f=GameMap.findTileAtGridIndex(b);return e},createRiver:function(){var a=new Point,b=null;a.equals(this.leftMiddleTile),a.y+=Math.round(randomRange(-1,1)),b=GameMap.findTileAtGridIndex(a);for(var c=0;null===b||!b.visible;)a=Navigation.moveRight(a,this.directionModifier[c%2]),b=GameMap.findTileAtGridIndex(a),c++;GameMap.addRiverTile(b);var d=0,e=0;c=0;for(var f=this.minRiverWidth,g=randomRange(0,1),h="none";a.x!==this.rightTopTile.x&&null!==b;){var i=randomRange(0,1);d=i<this.riverBends/2?0:i>this.riverBends/2?1:c%2,e<=-this.riverSpread?d=0:e>=this.riverSpread&&(d=1),0===d?e++:e--,a=Navigation.moveRight(a,this.directionModifier[d]),b=GameMap.findTileAtGridIndex(a);var j=new Point(a.x,a.y),k=!1,l=!1;if(null!==b&&b.visible){if(GameMap.addRiverTile(b),g=randomRange(0,1),this.riverRoughness>g){var m=Math.round(randomRange(this.minRiverWidth,this.maxRiverWidth));m>f?(f++,k=!0):f>m&&f--}for(var n=d,o=1;f>o;o++){for(n++,1===o&&("none"===h?h=n:l=h===n?!0:!1),j=Navigation["move"+this.directionModifier[n%2].charAt(0).toUpperCase()+this.directionModifier[n%2].slice(1)](j),b=GameMap.findTileAtGridIndex(j);b.type===tileTypes.river;)j=Navigation["move"+this.directionModifier[n%2].charAt(0).toUpperCase()+this.directionModifier[n%2].slice(1)](j),b=GameMap.findTileAtGridIndex(j);null!==b&&b.visible&&b.type!==tileTypes.river&&GameMap.addRiverTile(b)}}b=GameMap.findTileAtGridIndex(a),c++}},defineDistricts:function(){var a=Math.round(randomRange(this.minDistricts,this.maxDistricts));a%2===1?randomRange(0,1)>.5?(this.districtsTop=Math.ceil(a/2),this.districtsBottom=Math.floor(a/2)):(this.districtsTop=Math.floor(a/2),this.districtsBottom=Math.ceil(a/2)):(this.districtsTop=a/2,this.districtsBottom=a/2);for(var b=new Point,c=1;c<this.districtsTop;c++)b=this.getStartingPosition(c,"top"),this.defineDistrict(b,"top");for(var c=1;c<this.districtsBottom;c++)b=this.getStartingPosition(c,"bottom"),this.defineDistrict(b,"bottom");this.addLinesToDistricts()},getStartingPosition:function(a,b){var c="moveUp",d="moveDown";"bottom"===b&&(c="moveDown",d="moveUp");var e=Math.abs(this.leftTopTile.x)+this.rightTopTile.x,f=Math.round(a*e/this.districtsTop)+Math.round(randomRange(-this.borderOffset,this.borderOffset))+this.leftTopTile.x;"bottom"===b&&(f=Math.round(a*e/this.districtsBottom)+Math.round(randomRange(-this.borderOffset,this.borderOffset))+this.leftTopTile.x);for(var g=new Point(0,0),h=null,i=!1;!i;)if(g.x===f){do g=Navigation[c](g),h=GameMap.findTileAtGridIndex(g);while(null!==h);for(g=Navigation[d](g),h=GameMap.findTileAtGridIndex(g);!h.visible;)g=Navigation[d](g),h=GameMap.findTileAtGridIndex(g);i=!0}else{var j="jumpRight",k="moveLeft";0>f&&(j="jumpLeft",k="moveRight");do g=Navigation[j](g);while(g.x>f&&0>f||g.x<f&&f>0);g.x!==f&&(g=Navigation[k](g,"up"));do g=Navigation[c](g),h=GameMap.findTileAtGridIndex(g);while(null!==h);for(g=Navigation[d](g),h=GameMap.findTileAtGridIndex(g);!h.visible;)g=Navigation[d](g),h=GameMap.findTileAtGridIndex(g);i=!0}return this.districtLineStarts[this.districtLineStarts.length]=g,g},defineDistrict:function(a,b){var c="moveDown";"bottom"===b&&(c="moveUp");var d=new Point(a.x,a.y),e=GameMap.findTileAtGridIndex(d);e.setFill(this.borderGenColour);var f=0,g=0,h=0,i=c,j=c,k="moveRight",l="moveLeft",m="up";"moveDown"===c&&(m="down");for(var n=c;e.type!==tileTypes.river;)f=randomRange(0,1),this.borderRoughness>f&&(g=Math.round(randomRange(-this.borderVariance,this.borderVariance))),g>h?i!==l?(n=k,h++):n=j:h>g?(n=l,i!==k?(n=l,h--):n=j):n=j,d=Navigation[n](d,m),e=GameMap.findTileAtGridIndex(d),e.type!==tileTypes.river&&e.setFill(this.borderGenColour),i=n;d.equals(a);do d=Navigation.moveLeft(d,m),e=GameMap.findTileAtGridIndex(d);while(null===e||!e.visible||e.getFill()===this.borderGenColour);var o=["industrial","commercial","residential"],p=Math.round(randomRange(0,2));0!==GameMap.numberOfDistricts&&GameMap.districts[GameMap.numberOfDistricts-1].mainType===districtTypes[o[p]]&&(p=(p+Math.round(randomRange(1,2)))%3);var q=offsetColour(GameMap[o[p]+"Colour"],-70,70,!1),r=new District(o[p],q);if(this.fillDistrict(d,q,r),GameMap.addDistrict(r),GameMap.numberOfDistricts===this.districtsTop-1||GameMap.numberOfDistricts===this.districtsTop+this.districtsBottom-1){d.equals(a);do d=Navigation.moveRight(d,m),e=GameMap.findTileAtGridIndex(d);while(null===e||!e.visible||e.getFill()===this.borderGenColour);p=Math.round(randomRange(0,2)),0!==GameMap.numberOfDistricts&&GameMap.districts[GameMap.numberOfDistricts-1].mainType===districtTypes[o[p]]&&(p=(p+Math.round(randomRange(1,2)))%3),q=offsetColour(GameMap[o[p]+"Colour"],-70,70,!1),r=new District(o[p],q),this.fillDistrict(d,q,r),GameMap.addDistrict(r)}},fillDistrict:function(a,b,c){var d=new Point(a.x,a.y),e=GameMap.findTileAtGridIndex(d);c.addTile(e,GameMap.numberOfDistricts);for(var f=["moveUp","moveRight","moveRight","moveDown","moveLeft","moveLeft"],g=["","up","down","","down","up"],h=0;6>h;h++)d=Navigation[f[h]](a,g[h]),e=GameMap.findTileAtGridIndex(d),null!==e&&e.visible&&e.getFill()!==b&&e.getFill()!==this.borderGenColour&&e.type!==tileTypes.river&&null===e.districtIndex&&this.fillDistrict(d,b,c)},addLinesToDistricts:function(){for(var a=this.districtsTop-1+this.districtsBottom-1,b=new Point,c=null,d=0;a>d;d++){b=this.districtLineStarts[d],c=GameMap.findTileAtGridIndex(b);var e=!1,f="moveUp",g="up",h=d;d<this.districtsTop-1?(g="down",f="moveDown"):h=d+1;var i=this.districtLineStarts[d];for(GameMap.districts[h].addTile(c,h);!e;){var j=!1;b=i,b=Navigation.moveLeft(b,g),c=GameMap.findTileAtGridIndex(b),null!==c&&c.getFill()===this.borderGenColour&&(c.visible||(c.visible=!0),GameMap.districts[h].addTile(c,h),j=!0,i=b),b=i,b=Navigation[f](b,g),c=GameMap.findTileAtGridIndex(b),null!==c&&c.getFill()===this.borderGenColour&&(c.visible||(c.visible=!0),GameMap.districts[h].addTile(c,h),j=!0,i=b),b=i,b=Navigation.moveRight(b,g),c=GameMap.findTileAtGridIndex(b),null!==c&&c.getFill()===this.borderGenColour&&(c.visible||(c.visible=!0),GameMap.districts[h].addTile(c,h),j=!0,i=b),j||(e=!0)}}},validateMap:function(){var a=[],b=0,c="rgb(0,255,255)";for(var d in GameMap.tiles)for(var e in GameMap.tiles[d])GameMap.tiles[d][e].getFill()===GameMap.emptyColour&&GameMap.tiles[d][e].visible&&(a[b]=new Point(parseInt(d),parseInt(e)),b++);var f=!1;if(b>=3)f=!0;else for(var g in a)this.validateTile(a[g],c)||(f=!0);f?this.redoMapGeneration():this.districtLineStarts=[]},validateTile:function(a,b){var a=new Point(a.x-GameMap.calculateIndexAdjustment(),a.y-GameMap.calculateIndexAdjustment()),c=new Point(a.x,a.y),d=GameMap.findTileAtGridIndex(c);d.setFill(b);for(var e=["moveUp","moveRight","moveRight","moveDown","moveLeft","moveLeft"],f=["","up","down","","down","up"],g=!1,h=0,i=0;6>i;i++)c=Navigation[e[i]](a,f[i]),d=GameMap.findTileAtGridIndex(c),null!==d&&d.visible?d.type===tileTypes.river&&(g=!0):h++;return g&&GameMap.addRiverTile(GameMap.findTileAtGridIndex(a)),6===h&&(GameMap.findTileAtGridIndex(a).visible=!1,g=!0),g},redoMapGeneration:function(){this.districtLineStarts=[],MainGame.startState(MainGame.currentState)}},GameMap={radius:8,mapEdgeLength:13,gridCenter:new Point(250,275),mapWidth:0,mapHeight:0,tiles:[],numberOfTiles:0,districts:[],numberOfDistricts:0,destroyedDistricts:0,riverTiles:[],numberOfRiverTiles:0,riverAnimationCounter:0,singleSelection:!0,safeZone:0,timePerHour:2e3,startingPopulation:0,population:0,destruction:0,numberOfFollowers:{clerics:0,zealots:0},districtSpreadResistance:.5,indexOfFirstBottomDistrict:null,emptyColour:"rgb(0,222,50)",backgroundColour:"rgb(27,27,27)",hoverColour:"rgb(194,255,201)",selectedColour:"rgb(125,192,255)",hoverSelectedColour:"rgb(174,241,255)",riverColour:"rgb(50,50,255)",riverColourHighlight:"rgb(80,80,255)",industrialColour:"rgb(200,210,50)",commercialColour:"rgb(150,50,220)",residentialColour:"rgb(205,50,50)",initHexaGrid:function(){HexagonalGridSystem.setRadius(this.radius),this.calculateMapDimentions()},buildMap:function(a,b){this.setRadius(a),this.setMapEdgeLenght(b),this.initHexaGrid(),this.createGrid()},initialPopulation:function(){this.population=0;for(var a in this.districts)this.districts[a].initialPopulation(),this.population+=this.districts[a].population;this.startingPopulation=this.population},countPopulation:function(){this.population=0;for(var a in this.districts)this.population+=this.districts[a].population},countFollowers:function(){this.numberOfFollowers={clerics:0,zealots:0};for(var a in this.districts)this.districts[a].countFollowers(),this.numberOfFollowers.clerics+=this.districts[a].numberOfFollowers.clerics,this.numberOfFollowers.zealots+=this.districts[a].numberOfFollowers.zealots;UI.displayAreaInfo()},tryToSpawn:function(){for(var a in this.districts)this.districts[a].tryToSpawnFollowers()},tryToSetOnFire:function(){for(var a in this.districts)this.districts[a].tryToStartFire()},setTileSize:function(a){this.radius=a},setMapSize:function(a){this.mapEdgeLength=a},createGrid:function(){this.initHexaGrid();for(var a=-1*this.mapEdgeLength+1,b=a;b<this.mapEdgeLength;b++)for(var c=a;c<this.mapEdgeLength;c++)this.validGridPosition(b,c)&&this.addTile(b,c)},calculateMapDimentions:function(){var a=HexagonalGridSystem.calculateHexagonWidth(this.radius),b=HexagonalGridSystem.calculateHexagonHeight(this.radius),c=2*this.mapEdgeLength-1;this.mapWidth=.75*c*a,this.mapHeight=c*b},addTile:function(a,b){if(this.validGridPosition(a,b)){var c=HexagonalGridSystem.gridCoordToPixelCoord(new Point(a,b));c=this.centerPointAdjustment(c),"undefined"==typeof this.tiles[this.adjustIndex(a)]&&(this.tiles[this.adjustIndex(a)]=[]),this.tiles[this.adjustIndex(a)][this.adjustIndex(b)]=new Tile(this.radius,c.x,c.y,"none"),this.tiles[this.adjustIndex(a)][this.adjustIndex(b)].setMapIndex(this.adjustIndex(a),this.adjustIndex(b)),this.numberOfTiles++}},addDistrict:function(a){this.districts[this.numberOfDistricts]=a,this.numberOfDistricts++},addRiverTile:function(a){a.setFill(this.riverColour),a.setType("river"),a.setBaseColour(this.riverColour),this.riverTiles[this.numberOfRiverTiles]=a,this.numberOfRiverTiles++},animateRiver:function(){if("undefined"!=typeof this.riverTiles[0]){if(this.riverAnimationCounter<=0){this.riverAnimationCounter=5;var a=null;do a=this.riverTiles[Math.round(randomRange(0,this.numberOfRiverTiles-1))];while(a.animating);a.getFill()!==this.riverColour||a.animating?Motion.fadeTileColourTo(a,this.riverColour,500):Motion.fadeTileColourTo(a,this.riverColourHighlight,500)}this.riverAnimationCounter--}},calculateIndexAdjustment:function(){return this.mapEdgeLength-1},adjustIndex:function(a){return a+this.calculateIndexAdjustment()},centerPointAdjustment:function(a){return new Point(a.x+this.gridCenter.x,a.y+this.gridCenter.y)},validGridPosition:function(a,b){return a>=this.mapEdgeLength||b>=this.mapEdgeLength?!1:a<=-1*this.mapEdgeLength||b<=-1*this.mapEdgeLength?!1:a+b>=this.mapEdgeLength||a+b<=-1*this.mapEdgeLength?!1:this.gridPositionWithinBounds(a,b)?!0:!1},gridPositionWithinBounds:function(a,b){var c=this.safeZone+this.radius+100,d=this.safeZone+this.radius,e=450-this.safeZone-this.radius,f=500-this.safeZone-this.radius,g=HexagonalGridSystem.gridCoordToPixelCoord(new Point(a,b),this.gridCenter);return g.y<c||g.y>e?!1:g.x<d||g.x>f?!1:!0},validArrayIndex:function(a,b){return"undefined"!=typeof this.tiles[a]&&"undefined"!=typeof this.tiles[a][b]},drawMainBackground:function(){document.getElementById("mainBackground").width=500;var a=document.getElementById("mainBackground").getContext("2d"),b=a.createRadialGradient(250,280,150,250,280,450);b.addColorStop(0,"rgb(63,28,51)"),b.addColorStop(1,"rgb(2,1,8)"),a.fillStyle=b,a.fillRect(0,0,500,560);for(var c in this.tiles)for(var d in this.tiles[c])this.tiles[c][d].setStroke("rgb(183,134,170)",7.5),this.tiles[c][d].draw("mainBackground");for(var c in this.tiles)for(var d in this.tiles[c])this.tiles[c][d].setStroke("rgb(0,0,0)",.5),this.tiles[c][d].draw("mainBackground")},drawBackground:function(a){var b=null;for(var c in this.districts)for(var d in this.districts[c].tiles)this.districts[c].tiles[d].burning?(b=this.getColourForBackground(c,d),this.districts[c].tiles[d].setFill(Fire.fireColour)):this.districts[c].tiles[d].charred?(b=this.getColourForBackground(c,d),this.districts[c].tiles[d].setFill(Fire.charredColour)):(b=this.getColourForBackground(c,d),this.districts[c].tiles[d].setFill(this.districts[c].tiles[d].baseColour)),this.districts[c].tiles[d].draw(a),null!==b&&this.districts[c].tiles[d].setFill(b)},getColourForBackground:function(a,b){return this.districts[a].tiles[b].selected||this.districts[a].tiles[b].mouseOver?this.districts[a].tiles[b].getFill():null},setBaseHexagonColour:function(a){for(var b in this.tiles)for(var c in this.tiles[b])this.tiles[b][c].setFill(a)},drawActiveHexagons:function(a){for(var b in GameMap.tiles)for(var c in GameMap.tiles[b])(this.tiles[b][c].mouseOver||this.tiles[b][c].animating||this.tiles[b][c].type===tileTypes.river)&&this.tiles[b][c].draw(a)},setRadius:function(a){this.radius=a},setMapEdgeLenght:function(a){this.mapEdgeLength=a},setSafeZone:function(a){this.safeZone=a},getGridCenter:function(){return this.gridCenter},findTileAtGridIndex:function(a){return this.validGridPosition(a.x,a.y)?this.tiles[this.adjustIndex(a.x)][this.adjustIndex(a.y)]:null},setMouseOverState:function(a){if(!Input.mouseOver)for(var b in this.districts)this.districts[b].onMouseOff();var c=new Point(this.adjustIndex(a.x),this.adjustIndex(a.y));for(var b in this.districts)this.districts[b].mouseOver&&this.tiles[c.x][c.y].districtIndex!==parseInt(b)&&this.districts[b].onMouseOff()},clearMap:function(){this.tiles=[],this.numberOfTiles=0,this.districts=[],this.numberOfDistricts=0,this.destroyedDistricts=0,this.riverTiles=[],this.numberOfRiverTiles=0,this.riverAnimationCounter=0,this.safeZone=0,this.startingPopulation=0,this.population=0,this.destruction=0,this.numberOfFollowers={clerics:0,zealots:0},indexOfFirstBottomDistrict=null}},Navigation={moveUp:function(a){var b=new Point(0,0);return b.x=a.x,b.y=a.y-1,b},moveDown:function(a){var b=new Point(0,0);return b.x=a.x,b.y=a.y+1,b},moveLeft:function(a,b){var c=new Point(0,0);return"undefined"==typeof b&&(b="up"),0===b.indexOf("u")?(c.x=a.x-1,c.y=a.y):(c.x=a.x-1,c.y=a.y+1),c},moveRight:function(a,b){var c=new Point(0,0);return"undefined"==typeof b&&(b="up"),0===b.indexOf("u")?(c.x=a.x+1,c.y=a.y-1):(c.x=a.x+1,c.y=a.y),c},jumpLeft:function(a){var b=this.moveLeft(a,"up");return this.moveLeft(b,"down")},jumpRight:function(a){var b=this.moveRight(a,"up");return this.moveRight(b,"down")}},Input={mouseOffset:new Point(0,0),mousePosition:new Point(0,0),mouseHexaGridPos:new Point(0,0),mouseOver:!1,createInput:function(){this.addMouseListeners(MainGame.currentState)},addMouseListeners:function(a){null!==a&&null!==document.getElementById(a)&&(document.getElementById(a).addEventListener("click",this.onClick,!1),document.getElementById(a).addEventListener("mouseover",this.onMouseOver,!1),document.getElementById(a).addEventListener("mouseout",this.onMouseOut,!1),document.getElementById(a).addEventListener("mousemove",this.updateMousePosition,!1))},removeMouseListeners:function(a){null!==a&&null!==document.getElementById(a)&&(document.getElementById(a).removeEventListener("click",this.onClick,!1),document.getElementById(a).removeEventListener("mouseover",this.onMouseOver,!1),document.getElementById(a).removeEventListener("mouseout",this.onMouseOut,!1),document.getElementById(a).removeEventListener("mousemove",this.updateMousePosition,!1))},addKeyboardListeners:function(){document.addEventListener("keyup",this.keyUp,!1)},removeKeyboardListeners:function(){document.removeEventListener("keyup",this.keyUp,!1)},onClick:function(){"undefined"!=typeof MainGame.states[MainGame.currentState].onClick&&MainGame.states[MainGame.currentState].onClick()
},updateMousePosition:function(a){Input.mouseOver&&(Input.mousePosition.x=a.clientX-Input.mouseOffset.x,Input.mousePosition.y=a.clientY-Input.mouseOffset.y,Input.mouseHexaGridPos=HexagonalGridSystem.pixelCoordToGridCoord(Input.mousePosition,GameMap.gridCenter))},onMouseOver:function(){Input.mouseOver=!0,Input.calculateOffset()},onMouseOut:function(){Input.mouseOver=!1},calculateOffset:function(){this.mouseOffset.x=document.getElementById(MainGame.currentState).offsetLeft,this.mouseOffset.y=document.getElementById(MainGame.currentState).offsetTop},keyUp:function(a){27===a.keyCode&&(FireTech.show?FireTech.close():MainGame.startState("mainMenu"))}},Fire={fireColour:"rgb(255,158,62)",fireHighlight:"rgb(255,202,108)",fireDarkColour:"rgb(249,79,33)",charredColour:"rgb(66,61,47)",maxiumStrength:100,strenghtIncrease:1,burnTime:3e3,spreadTime:1e3,uncontroledEventIn:!1,uncontroledEventOut:!1,setOnFire:function(a){null===a||a.burning||a.charred||!a.visible||a.type===tileTypes.river||(Motion.fadeTileColourTo(a,this.fireColour,250),a.burning=!0,a.startedBurning=MainGame.timeNow(),a.killPeople(),GameMap.districts[a.districtIndex].newFireStarted())},tryToSetOnFire:function(a,b){if(null!==b&&!b.burning&&!b.charred&&b.visible&&b.type!==tileTypes.river){var c=b.spreadResistance-FireTech.tileSpreadMod-GameMap.destroyedDistricts*FireTech.globalSpreadResistanceMod;a.districtIndex!==b.districtIndex&&(c=GameMap.districtSpreadResistance-FireTech.districtSpreadMod-GameMap.destroyedDistricts*FireTech.globalSpreadResistanceMod),a.fireStrength>c*this.maxiumStrength&&b.calculateEffectiveFuel()>0&&(this.setOnFire(b),this.uncontroledEventIn||(UI.displayEvent("The fire has started spreading","uncontrollably through the city"),this.uncontroledEventIn=!0))}},burn:function(a,b){a.burn(),this.spreadFire(a,b),MainGame.timeNow()-a.startedBurning>=a.burnTime&&!a.charred&&this.fireBurnt(a)},spreadFire:function(a,b){var c=null,d=Math.round(randomRange(0,5)),e=[],f=[],g=[!1,!1,!1,!1,!1,!1];e=["moveUp","moveRight","moveRight","moveDown","moveLeft","moveLeft"],f=["","up","down","","down","up"];for(var h=0;6>h;h++){c=Navigation[e[d]](b,f[d]),this.spreadFireTo(a,c),g[d]=!0;do d=Math.round(randomRange(0,5));while(!g[d])}},spreadFireTo:function(a,b){GameMap.validArrayIndex(b.x,b.y)&&this.tryToSetOnFire(a,GameMap.tiles[b.x][b.y])},fireBurnt:function(a){a.charred=!0,a.burning=!1,a.mouseOver?Motion.fadeTileColourTo(a,GameMap.hoverColour,500):Motion.fadeTileColourTo(a,this.charredColour,500)}},Follower=function(a){this.fireClass=a,this.alive=!0};Follower.prototype={kill:function(){this.alive=!1}};var CityLevel={backgroundImage:null,timer1:null,redrawBuffer:0,placedFirstFollower:!1,followerTravelChance:.05,travelTimer:null,travelTestTime:1e3,firstFollowerMoved:!1,firstFollowerOverRiver:!1,endTimer:null,create:function(){UI.create(),GameMap.setSafeZone(10),GameMap.buildMap(8,23),GameMap.setBaseHexagonColour(GameMap.emptyColour),document.getElementById("GameHere").style.backgroundColor=GameMap.backgroundColour,this.createBackgroundImage()},input:function(){MainGame.gameOver||FireTech.show||this.mouseOverMap(Input.mouseHexaGridPos)},update:function(){MainGame.gameOver||(FireTech.show?FireTech.update():(UI.updateCounter(),GameMap.tryToSpawn(),GameMap.tryToSetOnFire(),this.followerTryToMove(),FireTech.allocatePoints(),this.checkVictory()))},render:function(){FireTech.render(),UI.render(),GameMap.drawActiveHexagons(MainGame.currentState);var a=!0;for(var b in GameMap.tiles)for(var c in GameMap.tiles[b])GameMap.tiles[b][c].burning&&(a=!1,this.redrawBuffer=2);for(var b in GameMap.tiles)for(var c in GameMap.tiles[b])GameMap.tiles[b][c].burning?(MainGame.timeNow()-this.timer1>=250||null===this.timer1)&&(this.timer1=MainGame.timeNow(),this.redrawBackground()):a&&this.redrawBuffer>0&&MainGame.timeNow()-this.timer1>=250&&(this.timer1=MainGame.timeNow(),this.redrawBackground(),this.redrawBuffer--),GameMap.tiles[b][c].burning&&!GameMap.tiles[b][c].charred&&Fire.burn(GameMap.tiles[b][c],new Point(parseInt(b),parseInt(c)));if(MainGame.gameOver){var d=document.getElementById(MainGame.currentState).getContext("2d"),e=d.createRadialGradient(250,280,10,250,280,450);e.addColorStop(0,"rgba(63,28,51,0.9)"),e.addColorStop(1,"rgba(2,1,8,0.9)"),d.fillStyle=e,d.fillRect(0,0,500,560),d.font="bold 45pt Arial",d.textAlign="center",d.fillStyle="rgb(255,194,197)",d.fillText("City Destroyed",250,100),d.font="bold 30pt Arial",d.fillStyle="rgb(185,215,238)",d.fillText("The city survived for",250,225),d.fillText(UI.days+" days and "+UI.hours+" hours",250,275),d.fillStyle="rgb(255,255,255)",d.font="normal 15pt Arial",d.fillText("Press the Esc key to return to the main menu",250,450)}},deleteState:function(){this.backgroundImage=null,this.timer1=null,this.redrawBuffer=0,this.placedFirstFollower=!1,this.firstFollowerMoved=!1,GameMap.clearMap(),FireTech.deleteMenu(),UI.deleteUI()},onClick:function(){MainGame.gameOver||(FireTech.show?FireTech.onClick():(Input.mousePosition.x>370&&Input.mousePosition.x<490&&Input.mousePosition.y>460&&Input.mousePosition.y<550&&UI.openTechTree(),this.placeFollower(),this.redrawBackground()))},createBackgroundImage:function(){GenerateMap.create(),GameMap.initialPopulation(),UI.displayAreaInfo(),GameMap.drawMainBackground()},redrawBackground:function(){MainGame.clearBackground(),GameMap.drawBackground("background")},tempRedraw:function(){MainGame.clearBackground(),GameMap.drawMap("background")},drawBurningTiles:function(a){for(var b in GameMap.tiles)for(var c in GameMap.tiles[b])GameMap.tiles[b][c].burning&&GameMap.tiles[b][c].draw(a)},mouseOverMap:function(a){if(Input.mouseOver){var b=GameMap.findTileAtGridIndex(a);if(null===b)return;null!==b.districtIndex&&GameMap.districts[b.districtIndex].onMouseOver(),GameMap.setMouseOverState(a)}else GameMap.setMouseOverState(a)},placeFollower:function(){if(!this.placedFirstFollower){var a=GameMap.findTileAtGridIndex(Input.mouseHexaGridPos);if(null!==a&&a.type!==tileTypes.river&&a.visible)for(var b in GameMap.districts)GameMap.districts[b].mouseOver&&(GameMap.districts[b].addFollower("cleric"),this.placedFirstFollower=!0,UI.displayEvent("A cleric of fire apeared in ","the "+GameMap.districts[b].name),Fire.setOnFire(GameMap.findTileAtGridIndex(Input.mouseHexaGridPos)))}},followerTryToMove:function(){if(FireTech.canTravel&&(null===this.travelTimer||MainGame.timeNow()-this.travelTimer>this.travelTestTime)){this.travelTimer=MainGame.timeNow();var a=randomRange(0,1);FireTech.travleChance+GameMap.destroyedDistricts*FireTech.travleChance+FireTech.followerMoveMod>a&&(a=randomRange(0,1),this.moveFollower(a>.5?"cleric":"zealot"))}},moveFollower:function(a){if(GameMap.numberOfFollowers[a+"s"]>1){for(var b=Math.round(randomRange(0,GameMap.numberOfDistricts-1)),c=0;GameMap.districts[b].numberOfFollowers[a+"s"]<=1;)if(b=Math.round(randomRange(0,GameMap.numberOfDistricts-1)),c++,c>30)return;var d=b,e=0;0===b||b===GameMap.indexOfFirstBottomDistrict?(e=FireTech.canCrossRiver?randomRange(0,1):0,e>.25?(d=0===b?GameMap.indexOfFirstBottomDistrict:0,this.firstFollowerOverRiver||(UI.displayEvent("A "+a+" has crossed the river!"),this.firstFollowerOverRiver=!0)):d++):b===GameMap.indexOfFirstBottomDistrict-1||b===GameMap.numberOfDistricts-1?(e=FireTech.canCrossRiver?randomRange(0,1):0,e>.25?d=b===GameMap.indexOfFirstBottomDistrict-1?GameMap.numberOfDistricts-1:GameMap.indexOfFirstBottomDistrict-1:d--):(e=randomRange(0,1),e>.5?d++:d--),GameMap.districts[d].destroyed||(GameMap.districts[b].followerMigrate(a,GameMap.districts[d]),this.firstFollowerMoved||(UI.displayEvent("A "+a+" has traveld to a","neighbouring district!"),this.firstFollowerMoved=!0))}},checkVictory:function(){GameMap.numberOfDistricts===GameMap.destroyedDistricts&&(this.gameOver||UI.displayEvent("The entire city has been","burned down in "+UI.days+"days!"),MainGame.gameOver=!0)}},UI={news:[],newsLines:2,timer:null,hours:0,days:0,areaToDisplay:"City",populationToDisplay:0,deathsToDisplay:0,destructionToDisplay:0,followersToDisplay:{clerics:0,zealots:0},create:function(){this.newsLines=2,this.news[0]="Click in a district to place",this.news[1]="your first cleric."},renderTop:function(a){a.strokeRect(5,5,490,95),a.textAlign="center",a.fillStyle="rgb(196,189,223)",a.fillRect(10,10,55,85),a.fillStyle="rgb(211,157,139)",a.fillRect(70,10,55,85),a.fillStyle="rgb(0,0,0)",a.font="normal 13pt Arial",a.fillText("DAY",37,30),a.fillText("HOUR",97,30),a.font="normal 35pt Arial",a.fillText(this.days,37,80),a.fillText(this.hours,97,80),a.fillStyle="rgb(187,203,242)",a.font="normal 17.5pt Arial",1===this.newsLines?a.fillText(this.news[0],310,60):(a.fillText(this.news[0],310,45),a.fillText(this.news[1],310,75))},renderBottom:function(a){a.strokeRect(5,455,490,100),a.textAlign="left",a.fillStyle="rgb(238,236,185)",a.font="bold 15pt Arial",a.fillText("Followers",15,480),a.font="normal 13pt Arial",a.fillText("Clerics: "+this.followersToDisplay.clerics,15,505),a.fillText("Zealots: "+this.followersToDisplay.zealots,15,525),a.fillStyle="rgb(183,134,170)",a.fillRect(135,460,1,90),a.fillStyle="rgb(242,170,158)",a.font="bold 15pt Arial",a.fillText(this.areaToDisplay,150,480),a.font="normal 13pt Arial",a.fillText("Population: "+this.populationToDisplay,150,505),a.fillText("Deaths: "+this.deathsToDisplay,150,525),a.fillText("Destruction: "+this.destructionToDisplay,150,545),Input.mousePosition.x>370&&Input.mousePosition.x<490&&Input.mousePosition.y>460&&Input.mousePosition.y<550&&!FireTech.show&&!MainGame.gameOver?(a.fillStyle="rgb(147,109,119)",a.fillRect(370,465,120,85),a.fillStyle="rgb(229,199,207)",a.fillRect(370,460,120,86)):(a.fillStyle="rgb(109,72,80)",a.fillRect(370,465,120,85),a.fillStyle="rgb(196,151,159)",a.fillRect(370,460,120,86)),a.fillStyle="rgb(20,2,6)",a.font="bold 18pt Arial",a.fillText("Influence",377,487),a.textAlign="center",a.font="normal 16pt Arial",a.fillText("Points: "+FireTech.techPoints,432,530)},render:function(){var a=document.getElementById(MainGame.currentState).getContext("2d");a.strokeStyle="rgb(183,134,170)",a.lineWidth=1,this.renderTop(a),this.renderBottom(a)},displayEvent:function(a,b){this.newsLines=1,this.news[0]=a,"undefined"!=typeof b&&(this.newsLines=2,this.news[1]=b)},displayAreaInfo:function(){this.getAreaInfo()},getAreaInfo:function(){this.areaToDisplay="City",this.populationToDisplay=GameMap.population,this.deathsToDisplay=GameMap.startingPopulation-GameMap.population,this.destructionToDisplay=GameMap.destruction,this.followersToDisplay=GameMap.numberOfFollowers;for(var a in GameMap.districts)GameMap.districts[a].mouseOver&&(this.areaToDisplay=GameMap.districts[a].name,this.populationToDisplay=GameMap.districts[a].population,this.deathsToDisplay=GameMap.districts[a].startingPopulation-GameMap.districts[a].population,this.destructionToDisplay=GameMap.districts[a].destruction,this.followersToDisplay=GameMap.districts[a].numberOfFollowers)},openTechTree:function(){FireTech.show||(FireTech.show=!0,FireTech.open())},updateCounter:function(){null===this.timer?this.timer=MainGame.timeNow():MainGame.timeNow()-this.timer>=GameMap.timePerHour&&(this.timer=MainGame.timeNow(),this.hours+1>=24?(this.days++,this.hours=0):this.hours++)},deleteUI:function(){this.news=[],this.newsLines=1,this.timer=null,this.hours=0,this.days=0}},iTxt=[];iTxt[0]="Clerics spawn is increased",iTxt[1]="Started fires will burn longer",iTxt[2]="Clerics spawn is greatly increased",iTxt[3]="Started fires will burn longer",iTxt[4]="Increased fire spread within districts",iTxt[5]="Increased fire spread between districts",iTxt[6]="Increased fire spread between districts",iTxt[7]="Increased fire spread within districts",iTxt[8]="Fires will be started more regularly",iTxt[9]="Started fires will burn longer",iTxt[10]="Followers spawn is increased",iTxt[11]="Started fires will burn longer",iTxt[12]="Fires will be started more regularly",iTxt[13]="Fires will be started more regularly",iTxt[14]="Zealots spawn is greatly increased",iTxt[15]="Zealots spawn is increased";var FTElement=function(a,b,c){this.visualHexa=new Hexagon(a,b,c),this.gridPoint=new Point,this.indexNumber=null,this.baseColour="",this.activeColour="",this.chosenColour="",this.selectable=!1,this.selected=!1,this.chosen=!1,this.skillInfo=""};FTElement.prototype={setGridPoint:function(a,b){this.gridPoint.x=a,this.gridPoint.y=b},draw:function(a){this.visualHexa.draw(a)}};var FireTech={show:!1,techPoints:0,techPointsSpent:0,selectedElement:!1,tier1:[0,15],tier2:[1,2,13,14],tier3:[3,4,5,10,11,12],tier4:[6,7,8,9],mouseHexaGridPos:new Point(0,0),followerSpawnMod:0,clericSpawnMod:0,followerMoveMod:0,fireProcMod:0,fuelModifierMod:0,tileSpreadMod:0,districtSpreadMod:0,canvasElement:null,canCrossRiver:!1,canTravel:!1,travleChance:.05,startingPoint:new Point(84,200),hexaRadius:35,hexaElements:[],numberOfHexaElements:0,elementsCreated:!1,globalSpreadResistanceMod:.01,hoverColour:"rgb(83,53,86)",slectedColour:"rgb(169,126,175)",create:function(){if(createCanvas(500,560,"TechTree",MainGame.elementID),this.canvasElement=document.getElementById("TechTree"),this.canvasElement.style.backgroundColor="rgba(20,7,16,0.9)",!this.elementsCreated){for(var a=(new Point,0);6>=a;a++)if(4>a)for(var b=-a;0>=b;b++)3===a?this.addHexaElement(new Point(a,b),"rgb(91,67,0)","rgb(255,194,0)","rgb(255,237,178)"):this.addHexaElement(new Point(a,b),"rgb(0,65,109)","rgb(24,121,199)","rgb(185,215,238)");else if(7>a)for(var b=-a+(a-3);-(a-3)>=b;b++)this.addHexaElement(new Point(a,b),"rgb(107,0,10)","rgb(255,52,63)","rgb(255,194,197)");this.attachInfo()}},addHexaElement:function(a,b,c,d){var e=new Point;e=HexagonalGridSystem.externalGridCoordToPixelCoord(new Point(a.x,a.y),this.startingPoint,this.hexaRadius+2),this.hexaElements[this.numberOfHexaElements]=new FTElement(this.hexaRadius,e.x,e.y),this.hexaElements[this.numberOfHexaElements].setGridPoint(a.x,a.y),this.hexaElements[this.numberOfHexaElements].indexNumber=this.numberOfHexaElements,this.hexaElements[this.numberOfHexaElements].baseColour=b,this.hexaElements[this.numberOfHexaElements].activeColour=c,this.hexaElements[this.numberOfHexaElements].chosenColour=d,this.hexaElements[this.numberOfHexaElements].visualHexa.setFill(this.hexaElements[this.numberOfHexaElements].baseColour),this.numberOfHexaElements++},update:function(){if(this.show){this.mouseHexaGridPos=HexagonalGridSystem.externalPixelCoordToGridCoord(Input.mousePosition,this.startingPoint,this.hexaRadius+2);for(var a in this.hexaElements)this.hexaElements[a].selectable=this.hexaElements[a].chosen?!0:!1,this.hexaElements[a].selected||this.hexaElements[a].visualHexa.setFill(this.hexaElements[a].baseColour);if(this.techPoints>0){var b="tier"+(this.techPointsSpent+1).toString();for(var c in this[b])this.hexaElements[this[b][c]].selected||(this.hexaElements[this[b][c]].visualHexa.setFill(this.hexaElements[this[b][c]].activeColour),this.hexaElements[this[b][c]].selectable=!0)}for(var a in this.hexaElements)this.hexaElements[a].chosen&&this.hexaElements[a].selected?this.hexaElements[a].visualHexa.setFill("rgb(255,255,255)"):this.hexaElements[a].chosen&&this.hexaElements[a].visualHexa.setFill(this.hexaElements[a].chosenColour),this.hexaElements[a].gridPoint.x===this.mouseHexaGridPos.x&&this.hexaElements[a].gridPoint.y===this.mouseHexaGridPos.y&&(this.hexaElements[a].visualHexa.getFill()!==this.hexaElements[a].activeColour||this.hexaElements[a].selected?this.hexaElements[a].chosen&&!this.hexaElements[a].selected&&this.hexaElements[a].visualHexa.setFill(this.hoverColour):this.hexaElements[a].visualHexa.setFill(this.hoverColour))}},render:function(){if(this.show){var a=this.canvasElement.getContext("2d");this.canvasElement.width=500;for(var b in this.hexaElements)this.hexaElements[b].draw("TechTree");Input.mousePosition.x>10&&Input.mousePosition.x<245&&Input.mousePosition.y>475&&Input.mousePosition.y<550?(a.fillStyle="rgb(147,109,119)",a.fillRect(10,480,235,70),a.fillStyle="rgb(229,199,207)",a.fillRect(10,475,235,70)):(a.fillStyle="rgb(109,72,80)",a.fillRect(10,480,235,70),a.fillStyle="rgb(196,151,159)",a.fillRect(10,475,235,70)),this.selectedElement?Input.mousePosition.x>255&&Input.mousePosition.x<490&&Input.mousePosition.y>475&&Input.mousePosition.y<550?(a.fillStyle="rgb(147,109,119)",a.fillRect(255,480,235,70),a.fillStyle="rgb(229,199,207)",a.fillRect(255,475,235,70)):(a.fillStyle="rgb(109,72,80)",a.fillRect(255,480,235,70),a.fillStyle="rgb(196,151,159)",a.fillRect(255,475,235,70)):(a.fillStyle="rgb(195,195,195)",a.fillRect(255,475,235,75)),a.textAlign="center",a.fillStyle="rgb(20,2,6)",a.font="bold 19pt Arial",a.fillText("Close",120,519),a.fillText("Assign Skill",375,519),a.fillStyle="rgb(185,215,238)";for(var c in this.hexaElements)this.hexaElements[c].selected&&a.fillText(this.hexaElements[c].skillInfo,250,380);a.font="normal 16pt Arial",this.techPoints>0&&this.selectedElement&&(1===this.techPointsSpent?a.fillText("Followers will now move between districts",250,415):3===this.techPointsSpent&&a.fillText("Followers will now be able to cross the river",250,415)),a.fillText("Available Influence Points: "+this.techPoints,250,45),this.elementsCreated=!0}},open:function(){this.create(),Input.removeMouseListeners(MainGame.currentState),Input.addMouseListeners("TechTree")},close:function(){this.hideMenu()},selectTech:function(){if(Input.mousePosition.x>46&&Input.mousePosition.x<452&&Input.mousePosition.y>72&&Input.mousePosition.y<328){this.selectedElement=!1;for(var a in this.hexaElements)this.hexaElements[a].selected?this.hexaElements[a].selected=!1:this.hexaElements[a].gridPoint.x===this.mouseHexaGridPos.x&&this.hexaElements[a].gridPoint.y===this.mouseHexaGridPos.y&&this.hexaElements[a].selectable&&(this.hexaElements[a].selected=!0,this.hexaElements[a].visualHexa.setFill(this.slectedColour),this.hexaElements[a].chosen||(this.selectedElement=!0))}},assignSkill:function(a){switch(a){case 0:this.clericSpawnMod+=.175,this.followerSpawnMod+=.1;break;case 1:this.fuelModifierMod+=.1,this.canTravel=!0;break;case 2:this.clericSpawnMod+=.225,this.followerSpawnMod+=.2,this.canTravel=!0;break;case 3:this.fuelModifierMod+=.2;break;case 4:this.tileSpreadMod+=.1;break;case 5:this.districtSpreadMod+=.1;break;case 6:this.canCrossRiver=!0,this.districtSpreadMod+=.2;break;case 7:this.canCrossRiver=!0,this.tileSpreadMod+=.2;break;case 8:this.canCrossRiver=!0,this.fireProcMod+=.2;break;case 9:this.canCrossRiver=!0,this.fuelModifierMod+=.2;break;case 10:this.clericSpawnMod-=.225,this.followerSpawnMod+=.1;break;case 11:this.followerSpawnMod+=.2;break;case 12:this.fireProcMod+=.15;break;case 13:this.fireProcMod+=.1,this.canTravel=!0;break;case 14:this.clericSpawnMod-=.225,this.followerSpawnMod+=.2,this.canTravel=!0;break;case 15:this.clericSpawnMod-=.175,this.followerSpawnMod+=.1}},attachInfo:function(){for(var a=0;16>a;a++)this.hexaElements[a].skillInfo=iTxt[a]},allocatePoints:function(){switch(this.techPointsSpent+this.techPoints){case 0:GameMap.destruction>=5&&(UI.displayEvent("First infulence point unlocked!","Click the influence button."),this.techPoints++);break;case 1:GameMap.destruction>=35&&this.techPoints++;break;case 2:GameMap.destruction>=150&&this.techPoints++;break;case 3:GameMap.destruction>=1e3&&this.techPoints++}},hideMenu:function(){Input.removeMouseListeners("TechTree"),Input.addMouseListeners(MainGame.currentState),deleteCanvas("TechTree"),this.canvasElement=null,this.show=!1},deleteMenu:function(){this.hideMenu(),this.followerSpawnMod=0,this.clericSpawnMod=0,this.fireProcMod=0,this.fuelModifierMod=0,this.tileSpreadMod=0,this.districtSpreadMod=0,this.canCrossRiver=!1,this.hexaElements=[],this.numberOfHexaElements=0,this.elementsCreated=!1,this.techPoints=0,this.techPointsSpent=0,this.selectedElement=!1,this.canTravel=!1},onClick:function(){if(FireTech.selectTech(),Input.mousePosition.x>10&&Input.mousePosition.x<245&&Input.mousePosition.y>475&&Input.mousePosition.y<550)this.close();else if(Input.mousePosition.x>255&&Input.mousePosition.x<490&&Input.mousePosition.y>475&&Input.mousePosition.y<550&&this.selectedElement)for(var a in this.hexaElements)this.hexaElements[a].selected&&!this.hexaElements[a].chosen&&(this.hexaElements[a].selected=!1,this.hexaElements[a].chosen=!0,this.assignSkill(this.hexaElements[a].indexNumber),this.selectedElement=!1,this.techPoints--,this.techPointsSpent++)}},Motion={animationLoop:function(a,b,c,d,e){function f(){var h;null===g&&(g=MainGame.timeNow()),h=MainGame.timeNow()-g,c(),e>h?a.requestId=requestAnimation(f):(a.animating=!1,a[d](b),window.cancelAnimationFrame(a.requestId),a.requestId=void 0)}a.requestId&&(window.cancelAnimationFrame(a.requestId),a.requestId=void 0),a.animating=!0;var g=null;a.requestId=requestAnimation(f)},fadeTileColourTo:function(a,b,c){function d(){e.r+=Math.round(Motion.adjustValue(f.r,g.r,c)),e.g+=Math.round(Motion.adjustValue(f.g,g.g,c)),e.b+=Math.round(Motion.adjustValue(f.b,g.b,c)),a.setFill(rgbIntToString(e))}"undefined"==typeof c&&(c=400);var e=rgbStringToInt(a.getFill()),f=rgbStringToInt(a.getFill()),g=rgbStringToInt(b);this.animationLoop(a,b,d,"setFill",c)},adjustValue:function(a,b,c){return(b-a)*(MainGame.lastFrameTime/c)}},Game=function(a){this.stageWidth=500,this.stageHeight=560,this.elementID=a,this.currentState=null,this.states=[],this.lastUpdate=(new Date).getTime(),this.lastFrameTime=1e3/60,this.secondTimer=null,this.gameStarted=!1,this.gameOver=!1,this.onGameCreationRun()};Game.prototype={onGameCreationRun:function(){document.getElementById("GameHere").style.width=this.stageWidth.toString()+"px",document.getElementById("GameHere").style.height=this.stageHeight.toString()+"px",Input.addKeyboardListeners()},create:function(){this.gameOver=!1,null===document.getElementById("mainBackground")&&createCanvas(this.stageWidth,this.stageHeight,"mainBackground",this.elementID),null===document.getElementById("background")&&createCanvas(this.stageWidth,this.stageHeight,"background",this.elementID),createCanvas(this.stageWidth,this.stageHeight,this.currentState,this.elementID),this.states[this.currentState].create(),this.gameStarted||(GameLoop(),this.gameStarted=!0)},input:function(){"function"==typeof this.states[this.currentState].input&&this.states[this.currentState].input()},update:function(){this.calculateLastFrameTime(),"function"==typeof this.states[this.currentState].update&&this.states[this.currentState].update()},render:function(){document.getElementById(this.currentState).width=this.stageWidth,"function"==typeof this.states[this.currentState].render&&this.states[this.currentState].render(),GameMap.animateRiver()},deleteState:function(){deleteCanvas(this.currentState),deleteCanvas("background"),deleteCanvas("mainBackground"),"undefined"!=typeof this.states[this.currentState]&&"function"==typeof this.states[this.currentState].deleteState&&this.states[this.currentState].deleteState()},addState:function(a,b){for(var c in this.states)if(c===a)return;this.states[a]=b},startState:function(a){for(var b in this.states)if(b===a)return Input.removeMouseListeners(this.currentState),this.deleteState(),this.currentState=a,this.create(),void Input.addMouseListeners(this.currentState)},clearBackground:function(){document.getElementById("background").width=this.stageWidth},calculateLastFrameTime:function(){var a=(new Date).getTime();this.lastFrameTime=a-this.lastUpdate,this.lastFrameTime>1e3&&(this.lastFrameTime=60),this.lastUpdate=a},timeNow:function(){return this.lastUpdate}};</script>
<script>var MainGame = new Game("GameHere");MainGame.addState("mainMenu", StartMenu);MainGame.addState("city", CityLevel);MainGame.startState("mainMenu");</script></body></html>